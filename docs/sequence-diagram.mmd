sequenceDiagram
    participant C as Client
    participant A as API (FastAPI)
    participant O as OPA
    participant D as Postgres
    participant L as Audit stdout

    C->>A: GET /v1/tenant/{tenant_id}/resource + Bearer JWT
    A->>A: Validate JWT (HS256, exp, iss, aud)

    alt Missing or invalid token
        A-->>C: 401 Unauthorized
    else Token valid
        A->>A: Normalize subject {sub, tenant, roles, attrs}
        A->>O: POST /v1/data/authz/decision (subject, request, resource)
        O-->>A: {allow, reason}
        A->>L: Emit authz audit event (allow/deny)

        alt OPA deny or fail-closed decision
            A-->>C: 403 Forbidden (reason)
        else OPA allow
            A->>D: SELECT ... WHERE tenant_id = :tenant_id
            alt DB success
                D-->>A: tenant-scoped rows
                A-->>C: 200 OK + rows
            else DB unavailable/error
                A-->>C: 503 Service Unavailable (database_unavailable)
            end
        end
    end
